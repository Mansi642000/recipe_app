{% extends "base.html" %}
{% block content %}
<div class="add-recipe-container">
  <div class="recipe-card">
    <h2 class="form-heading">{% if edit %}Edit Recipe{% else %}Add Recipe{% endif %}</h2>

    <form method="POST" id="recipe-form" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div class="form-group">
        {{ form.title.label }}<br>
        {{ form.title(size=50, class="form-control") }}
      </div>

      <div class="form-group">
        {{ form.image_file.label }}<br>
        {{ form.image_file(class="form-control-file") }}
      </div>

      <div class="form-group">
        {{ form.image_url.label }}<br>
        {{ form.image_url(size=60, class="form-control") }}
        <small class="text-muted">Or provide an external image URL (optional)</small>
      </div>

      <div class="form-group">
        {{ form.ingredients.label }}<br>
        {{ form.ingredients(id="ingredients", rows=4, class="form-control") }}
        <small class="text-muted">Enter ingredients comma-separated (e.g. "apple, sugar, milk")</small>
      </div>

      <button type="button" id="calculate-btn" class="btn btn-primary mt-2">Calculate Nutrition</button>

      <div id="nutrition-result" style="display:none;" class="nutrition-box mt-3">
        <h5>Estimated Nutrition</h5>
        <ul id="nutrition-data" style="list-style:none; padding-left:0; margin:0;"></ul>
        <small class="text-muted">Values are auto-calculated from your dataset.</small>
      </div>

      <div class="form-group mt-3">
        {{ form.instructions.label }}<br>
        {{ form.instructions(rows=5, class="form-control") }}
      </div>

      <div class="form-group">
        {{ form.calories.label }}<br>
        {{ form.calories(id="calories_field", class="form-control") }}
      </div>

      <div class="form-group">
        {{ form.youtube_url.label }}<br>
        {{ form.youtube_url(size=100, class="form-control") }}
      </div>

      <div class="form-group mt-3">
        {{ form.submit(class="btn btn-success") }}
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const calcBtn = document.getElementById('calculate-btn');
  const ingredientsEl = document.getElementById('ingredients');
  const nutritionDiv = document.getElementById('nutrition-result');
  const nutritionList = document.getElementById('nutrition-data');
  const caloriesField = document.getElementById('calories_field');
  const csrfInput = document.querySelector('input[name="csrf_token"]');
  const csrfToken = csrfInput ? csrfInput.value : '';

  calcBtn.addEventListener('click', async () => {
    const ingredients = ingredientsEl.value || '';
    if (!ingredients.trim()) {
      alert('Please enter ingredients first (comma-separated).');
      return;
    }

    try {
      const res = await fetch('{{ url_for("calculate_nutrition") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ ingredients })
      });

      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      nutritionList.innerHTML = '';

      const preferred = ['calories','proteins','fats','carbs','fibers'];
      preferred.forEach(k => {
        if (k in data) {
          const li = document.createElement('li');
          li.textContent = `${k}: ${Number(data[k]).toFixed(2)}`;
          nutritionList.appendChild(li);
        }
      });

      nutritionDiv.style.display = 'block';
      if ('calories' in data) caloriesField.value = Number(data.calories).toFixed(2);
    } catch (err) {
      console.error(err);
      alert('Error calculating nutrition.');
    }
  });
})();
</script>
{% endblock %}
