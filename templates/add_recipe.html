{% extends "base.html" %}
{% block content %}
  <h2>{% if edit %}Edit Recipe{% else %}Add Recipe{% endif %}</h2>

  <form method="POST" id="recipe-form" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <p>
      {{ form.title.label }}<br>
      {{ form.title(size=40) }}
    </p>

    <p>
      {{ form.image_file.label }}<br>
      {{ form.image_file() }}
    </p>

    <p>
      {{ form.image_url.label }}<br>
      {{ form.image_url(size=60) }}
      <br><small>Or provide an external image URL (optional).</small>
    </p>

    <p>
      {{ form.ingredients.label }}<br>
      {{ form.ingredients(id="ingredients", rows=5, cols=40) }}
      <br><small>Enter ingredients comma-separated (e.g. "apple, sugar, milk")</small>
    </p>

    <p>
      <button type="button" id="calculate-btn">Calculate Nutrition</button>
    </p>

    <div id="nutrition-result" style="display:none; margin-top:10px; border:1px solid #ddd; padding:8px;">
      <h4>Estimated Nutrition (per total ingredients)</h4>
      <ul id="nutrition-data" style="list-style:none; padding-left:0; margin:0;"></ul>
      <p style="font-size:0.9em; color:#666; margin-top:6px;">These values come from your dataset matches.</p>
    </div>

    <p>
      {{ form.instructions.label }}<br>
      {{ form.instructions(rows=5, cols=40) }}
    </p>

    <p>
      {{ form.calories.label }}<br>
      {{ form.calories(id="calories_field") }}
      <br><small>If you want to use the calculated value, click Calculate then submit â€” the numeric value will be placed into this field automatically.</small>
    </p>

    <p>
      {{ form.youtube_url.label }}<br>
      {{ form.youtube_url(size=250) }}
    </p>

    <p>{{ form.submit() }}</p>
  </form>

  <script>
  (function(){
    const calcBtn = document.getElementById('calculate-btn');
    const ingredientsEl = document.getElementById('ingredients');
    const nutritionDiv = document.getElementById('nutrition-result');
    const nutritionList = document.getElementById('nutrition-data');
    const caloriesField = document.getElementById('calories_field');

    // get csrf token value from the hidden input generated by form.hidden_tag()
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    const csrfToken = csrfInput ? csrfInput.value : '';

    calcBtn.addEventListener('click', async () => {
      const ingredients = ingredientsEl.value || '';
      if (!ingredients.trim()) {
        alert('Please enter ingredients first (comma-separated).');
        return;
      }

      try {
        const res = await fetch('{{ url_for("calculate_nutrition") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken  // include CSRF token for Flask-WTF
          },
          body: JSON.stringify({ ingredients })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error('Server error: ' + text);
        }

        const data = await res.json();

        // clear list
        nutritionList.innerHTML = '';

        // display a compact selection of key nutrients first (if available),
        // then display the rest.
        const preferred = ['calories','proteins','fats','carbs','fibers'];
        preferred.forEach(k => {
          if (k in data) {
            const li = document.createElement('li');
            li.textContent = `${k}: ${Number(data[k]).toFixed(2)}`;
            nutritionList.appendChild(li);
          }
        });

        // show a divider and remaining nutrients (optional)
        const otherKeys = Object.keys(data).filter(k => !preferred.includes(k));
        if (otherKeys.length) {
          const hr = document.createElement('hr');
          hr.style.margin = '6px 0';
          nutritionList.appendChild(hr);
          otherKeys.forEach(k => {
            const li = document.createElement('li');
            li.style.fontSize = '0.9em';
            li.textContent = `${k}: ${Number(data[k]).toFixed(2)}`;
            nutritionList.appendChild(li);
          });
        }

        // show the block
        nutritionDiv.style.display = 'block';

        // put calories into the calories field so it gets saved when submitting
        if ('calories' in data && caloriesField) {
          // store as two-decimal string so backend can parse/round consistently
          caloriesField.value = Number(data.calories).toFixed(2);
        }
      } catch (err) {
        console.error(err);
        alert('Error calculating nutrition. Open console for details.');
      }
    });
  })();
  </script>
{% endblock %}
